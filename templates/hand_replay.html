<div class="space-y-6" id="hand-replay-container">
    <!-- Replay Controls -->
    <div class="bg-gray-100 rounded-lg p-4">
        <div class="flex items-center justify-between mb-4">
            <h4 class="font-bold text-lg">Hand Replay</h4>
            <div class="text-sm text-gray-600">
                Step <span id="current-step">0</span> of <span id="total-steps">0</span>
            </div>
        </div>
        
        <!-- Control Buttons -->
        <div class="flex items-center justify-center space-x-4">
            <button id="first-btn" class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-300" disabled>
                ⏮️ First
            </button>
            <button id="prev-btn" class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-300" disabled>
                ⏪ Previous
            </button>
            <button id="play-pause-btn" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                ▶️ Play
            </button>
            <button id="next-btn" class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                ⏩ Next
            </button>
            <button id="last-btn" class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                ⏭️ Last
            </button>
        </div>
        
        <!-- Speed Control -->
        <div class="flex items-center justify-center mt-4 space-x-2">
            <label class="text-sm text-gray-600">Speed:</label>
            <select id="speed-select" class="px-2 py-1 border rounded">
                <option value="2000">Slow (2s)</option>
                <option value="1000" selected>Normal (1s)</option>
                <option value="500">Fast (0.5s)</option>
            </select>
        </div>
        
        <!-- Progress Bar -->
        <div class="mt-4">
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div id="progress-bar" class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- Current Action Description -->
    <div class="bg-yellow-50 rounded-lg p-4">
        <div class="text-center">
            <h5 class="font-medium text-lg" id="action-description">Loading replay...</h5>
            <div class="text-sm text-gray-600 mt-1">
                <span id="current-street">-</span> | Pot: $<span id="current-pot">0</span>
            </div>
        </div>
    </div>

    <!-- Poker Table Visual -->
    <div class="bg-green-600 rounded-lg p-6 relative min-h-96">
        <!-- Board Cards -->
        <div class="absolute top-4 left-1/2 transform -translate-x-1/2">
            <div class="flex space-x-2" id="board-cards">
                <!-- Board cards will be populated here -->
            </div>
        </div>
        
        <!-- Pot Display -->
        <div class="absolute top-16 left-1/2 transform -translate-x-1/2 bg-white rounded-lg px-4 py-2">
            <div class="text-center">
                <div class="text-xs text-gray-600">Pot</div>
                <div class="font-bold text-lg">$<span id="pot-display">0</span></div>
            </div>
        </div>
        
        <!-- Players positioned around the table -->
        <div class="relative h-full">
            <div id="players-container" class="relative h-full">
                <!-- Players will be positioned here -->
            </div>
        </div>
    </div>

    <!-- Players Info Panel -->
    <div class="bg-blue-50 rounded-lg p-4">
        <h4 class="font-bold text-lg mb-2">Players</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="players-info">
            <!-- Player cards will be populated here -->
        </div>
    </div>
</div>

<script>
class HandReplay {
    constructor(playId) {
        console.log(`HandReplay constructor called with playId: ${playId}`);
        this.playId = playId;
        this.steps = [];
        this.currentStep = 0;
        this.isPlaying = false;
        this.playInterval = null;
        this.speed = 1000; // 1 second default
        
        console.log('Initializing elements...');
        this.initializeElements();
        console.log('Binding events...');
        this.bindEvents();
        console.log('Loading replay data...');
        this.loadReplayData();
    }
    
    initializeElements() {
        this.firstBtn = document.getElementById('first-btn');
        this.prevBtn = document.getElementById('prev-btn');
        this.playPauseBtn = document.getElementById('play-pause-btn');
        this.nextBtn = document.getElementById('next-btn');
        this.lastBtn = document.getElementById('last-btn');
        this.speedSelect = document.getElementById('speed-select');
        this.progressBar = document.getElementById('progress-bar');
        this.currentStepSpan = document.getElementById('current-step');
        this.totalStepsSpan = document.getElementById('total-steps');
        this.actionDescription = document.getElementById('action-description');
        this.currentStreet = document.getElementById('current-street');
        this.currentPot = document.getElementById('current-pot');
        this.potDisplay = document.getElementById('pot-display');
        this.boardCards = document.getElementById('board-cards');
        this.playersContainer = document.getElementById('players-container');
        this.playersInfo = document.getElementById('players-info');
    }
    
    bindEvents() {
        this.firstBtn.addEventListener('click', () => this.goToStep(0));
        this.prevBtn.addEventListener('click', () => this.previousStep());
        this.playPauseBtn.addEventListener('click', () => this.togglePlay());
        this.nextBtn.addEventListener('click', () => this.nextStep());
        this.lastBtn.addEventListener('click', () => this.goToStep(this.steps.length - 1));
        this.speedSelect.addEventListener('change', (e) => {
            this.speed = parseInt(e.target.value);
        });
    }
    
    async loadReplayData() {
        try {
            console.log(`Loading replay data for play_id: ${this.playId}`);
            this.actionDescription.textContent = `Loading replay for ${this.playId}...`;
            
            const response = await fetch(`/api/hands/${this.playId}/replay`);
            console.log('Response status:', response.status);
            
            const data = await response.json();
            console.log('Replay data loaded:', data);
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            this.steps = data.steps;
            this.totalStepsSpan.textContent = this.steps.length;
            console.log(`Loaded ${this.steps.length} steps`);
            this.updateDisplay();
        } catch (error) {
            console.error('Error loading replay data:', error);
            this.actionDescription.textContent = 'Error loading replay data: ' + error.message;
        }
    }
    
    goToStep(step) {
        if (step >= 0 && step < this.steps.length) {
            this.currentStep = step;
            this.updateDisplay();
        }
    }
    
    nextStep() {
        if (this.currentStep < this.steps.length - 1) {
            this.currentStep++;
            this.updateDisplay();
        } else if (this.isPlaying) {
            this.pause();
        }
    }
    
    previousStep() {
        if (this.currentStep > 0) {
            this.currentStep--;
            this.updateDisplay();
        }
    }
    
    togglePlay() {
        if (this.isPlaying) {
            this.pause();
        } else {
            this.play();
        }
    }
    
    play() {
        this.isPlaying = true;
        this.playPauseBtn.textContent = '⏸️ Pause';
        this.playInterval = setInterval(() => {
            this.nextStep();
        }, this.speed);
    }
    
    pause() {
        this.isPlaying = false;
        this.playPauseBtn.textContent = '▶️ Play';
        if (this.playInterval) {
            clearInterval(this.playInterval);
            this.playInterval = null;
        }
    }
    
    updateDisplay() {
        if (!this.steps.length) return;
        
        const step = this.steps[this.currentStep];
        
        // Update step counter
        this.currentStepSpan.textContent = this.currentStep + 1;
        
        // Update progress bar
        const progress = ((this.currentStep) / (this.steps.length - 1)) * 100;
        this.progressBar.style.width = `${progress}%`;
        
        // Update action description
        this.actionDescription.textContent = step.description;
        this.currentStreet.textContent = step.street;
        this.currentPot.textContent = step.pot_size;
        this.potDisplay.textContent = step.pot_size;
        
        // Update board cards
        this.updateBoardCards(step.board);
        
        // Update players
        this.updatePlayers(step.players);
        
        // Update button states
        this.firstBtn.disabled = this.currentStep === 0;
        this.prevBtn.disabled = this.currentStep === 0;
        this.nextBtn.disabled = this.currentStep === this.steps.length - 1;
        this.lastBtn.disabled = this.currentStep === this.steps.length - 1;
    }
    
    updateBoardCards(board) {
        this.boardCards.innerHTML = '';
        board.forEach(card => {
            const cardElement = document.createElement('div');
            cardElement.className = 'bg-white border-2 border-gray-300 rounded-lg w-12 h-16 flex items-center justify-center font-bold text-sm';
            cardElement.textContent = card;
            this.boardCards.appendChild(cardElement);
        });
        
        // Add empty card slots
        for (let i = board.length; i < 5; i++) {
            const cardElement = document.createElement('div');
            cardElement.className = 'bg-gray-200 border-2 border-gray-300 rounded-lg w-12 h-16 flex items-center justify-center text-gray-400';
            cardElement.textContent = '?';
            this.boardCards.appendChild(cardElement);
        }
    }
    
    updatePlayers(players) {
        // Update players info panel
        this.playersInfo.innerHTML = '';
        players.forEach(player => {
            const playerCard = document.createElement('div');
            playerCard.className = `p-3 rounded-lg border-2 ${player.is_active ? 'bg-white border-green-400' : 'bg-gray-100 border-gray-300'}`;
            
            playerCard.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <div class="font-medium">${player.name}</div>
                        <div class="text-xs text-gray-600">${player.position}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold">$${player.stack}</div>
                        ${player.current_bet > 0 ? `<div class="text-xs text-blue-600">Bet: $${player.current_bet}</div>` : ''}
                    </div>
                </div>
                ${player.hole_cards ? `<div class="text-sm bg-gray-50 rounded px-2 py-1">${player.hole_cards}</div>` : ''}
            `;
            
            this.playersInfo.appendChild(playerCard);
        });
        
        // Position players around the table (simplified positioning)
        this.playersContainer.innerHTML = '';
        const positions = [
            { top: '80%', left: '20%' },  // SB
            { top: '80%', left: '80%' },  // BB  
            { top: '60%', left: '90%' },  // UTG
            { top: '40%', left: '90%' },  // UTG1
            { top: '20%', left: '80%' },  // MP
            { top: '20%', left: '20%' },  // LJ
            { top: '40%', left: '10%' },  // HJ
            { top: '60%', left: '10%' },  // CO
            { top: '80%', left: '50%' },  // BTN
        ];
        
        players.forEach((player, index) => {
            const pos = positions[index] || positions[0];
            const playerElement = document.createElement('div');
            playerElement.className = `absolute transform -translate-x-1/2 -translate-y-1/2 ${player.is_active ? 'bg-white' : 'bg-gray-200'} rounded-lg p-2 border-2 ${player.is_active ? 'border-green-400' : 'border-gray-300'} min-w-20 text-center`;
            playerElement.style.top = pos.top;
            playerElement.style.left = pos.left;
            
            playerElement.innerHTML = `
                <div class="text-xs font-medium">${player.name}</div>
                <div class="text-xs">$${player.stack}</div>
                ${player.current_bet > 0 ? `<div class="text-xs text-blue-600">$${player.current_bet}</div>` : ''}
            `;
            
            this.playersContainer.appendChild(playerElement);
        });
    }
}

// Global function to initialize replay
window.initHandReplay = function(playId) {
    console.log(`initHandReplay called with playId: ${playId}`);
    // Clean up any existing replay instance
    if (window.currentReplay) {
        if (window.currentReplay.playInterval) {
            clearInterval(window.currentReplay.playInterval);
        }
        window.currentReplay = null;
    }
    
    // Create new replay instance
    setTimeout(() => {
        console.log('Creating new HandReplay instance');
        window.currentReplay = new HandReplay(playId);
    }, 100);
};

// Auto-initialize if template is loaded with play_id
(function() {
    const playId = '{{ hand.play_id if hand else "" }}';
    if (playId) {
        console.log(`Auto-initializing replay for playId: ${playId}`);
        // Wait for DOM to be ready, then initialize
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(() => {
                    window.initHandReplay(playId);
                }, 200);
            });
        } else {
            setTimeout(() => {
                window.initHandReplay(playId);
            }, 200);
        }
    }
})();
</script>