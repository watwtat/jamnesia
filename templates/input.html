{% extends "base.html" %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="card">
        <h2 class="text-2xl font-bold mb-6">Poker Hand Input</h2>
        
        <form id="hand-form" class="space-y-6">
            <!-- Game Settings -->
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Small Blind</label>
                    <input type="number" name="small_blind" value="1" step="0.5" class="form-input" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Big Blind</label>
                    <input type="number" name="big_blind" value="2" step="0.5" class="form-input" required>
                </div>
            </div>
            
            <!-- Player Settings -->
            <div>
                <h3 class="text-lg font-bold mb-4">Player Settings</h3>
                <div id="players-container">
                    <div class="player-row grid md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Player Name</label>
                            <input type="text" name="player_name_0" placeholder="Alice" class="form-input" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Stack</label>
                            <input type="number" name="player_stack_0" value="100" step="0.5" class="form-input" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Hole Cards</label>
                            <input type="text" name="player_cards_0" placeholder="AsKh" maxlength="4" class="form-input">
                        </div>
                        <div class="flex items-end">
                            <button type="button" class="btn btn-secondary" onclick="removePlayer(this)">Remove</button>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn-secondary" onclick="addPlayer()">Add Player</button>
            </div>
            
            <!-- Board Cards -->
            <div>
                <h3 class="text-lg font-bold mb-4">Board Cards</h3>
                <div class="grid md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Flop</label>
                        <input type="text" name="flop" placeholder="AhKd5c" maxlength="6" class="form-input">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Turn</label>
                        <input type="text" name="turn" placeholder="9s" maxlength="2" class="form-input">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">River</label>
                        <input type="text" name="river" placeholder="3d" maxlength="2" class="form-input">
                    </div>
                </div>
            </div>
            
            <!-- Actions -->
            <div>
                <h3 class="text-lg font-bold mb-4">Actions</h3>
                <div id="actions-container">
                    <div class="action-row grid md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Player</label>
                            <input type="text" name="action_player_0" placeholder="Alice" class="form-input" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Action</label>
                            <select name="action_type_0" class="form-input" required>
                                <option value="">Select action</option>
                                <option value="fold">Fold</option>
                                <option value="check">Check</option>
                                <option value="call">Call</option>
                                <option value="bet">Bet</option>
                                <option value="raise">Raise</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Amount</label>
                            <input type="number" name="action_amount_0" step="0.5" class="form-input">
                        </div>
                        <div class="flex items-end">
                            <button type="button" class="btn btn-secondary" onclick="removeAction(this)">Remove</button>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn-secondary" onclick="addAction()">Add Action</button>
            </div>
            
            <div class="flex space-x-4">
                <button type="submit" class="btn btn-primary">Save Hand</button>
                <a href="/" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
        
        <div id="form-result" class="mt-6"></div>
    </div>
</div>

<script>
let playerCount = 1;
let actionCount = 1;

function addPlayer() {
    const container = document.getElementById('players-container');
    const newRow = document.createElement('div');
    newRow.className = 'player-row grid md:grid-cols-4 gap-4 mb-4';
    newRow.innerHTML = `
        <div>
            <label class="block text-sm font-medium mb-2">Player Name</label>
            <input type="text" name="player_name_${playerCount}" class="form-input" required>
        </div>
        <div>
            <label class="block text-sm font-medium mb-2">Stack</label>
            <input type="number" name="player_stack_${playerCount}" value="100" step="0.5" class="form-input" required>
        </div>
        <div>
            <label class="block text-sm font-medium mb-2">Hole Cards</label>
            <input type="text" name="player_cards_${playerCount}" maxlength="4" class="form-input">
        </div>
        <div class="flex items-end">
            <button type="button" class="btn btn-secondary" onclick="removePlayer(this)">Remove</button>
        </div>
    `;
    container.appendChild(newRow);
    playerCount++;
}

function removePlayer(button) {
    const playerRows = document.querySelectorAll('.player-row');
    if (playerRows.length > 1) {
        button.closest('.player-row').remove();
    }
}

function addAction() {
    const container = document.getElementById('actions-container');
    const newRow = document.createElement('div');
    newRow.className = 'action-row grid md:grid-cols-4 gap-4 mb-4';
    newRow.innerHTML = `
        <div>
            <label class="block text-sm font-medium mb-2">Player</label>
            <input type="text" name="action_player_${actionCount}" class="form-input" required>
        </div>
        <div>
            <label class="block text-sm font-medium mb-2">Action</label>
            <select name="action_type_${actionCount}" class="form-input" required>
                <option value="">Select action</option>
                <option value="fold">Fold</option>
                <option value="check">Check</option>
                <option value="call">Call</option>
                <option value="bet">Bet</option>
                <option value="raise">Raise</option>
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium mb-2">Amount</label>
            <input type="number" name="action_amount_${actionCount}" step="0.5" class="form-input">
        </div>
        <div class="flex items-end">
            <button type="button" class="btn btn-secondary" onclick="removeAction(this)">Remove</button>
        </div>
    `;
    container.appendChild(newRow);
    actionCount++;
}

function removeAction(button) {
    const actionRows = document.querySelectorAll('.action-row');
    if (actionRows.length > 1) {
        button.closest('.action-row').remove();
    }
}

document.getElementById('hand-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    // プレイヤー情報を収集
    const players = [];
    const holeCards = {};
    
    for (let i = 0; i < playerCount; i++) {
        const name = formData.get(`player_name_${i}`);
        const stack = formData.get(`player_stack_${i}`);
        const cards = formData.get(`player_cards_${i}`);
        
        if (name && stack) {
            players.push({
                name: name,
                stack: parseFloat(stack)
            });
            
            if (cards) {
                holeCards[name] = cards;
            }
        }
    }
    
    // アクション情報を収集
    const actions = [];
    for (let i = 0; i < actionCount; i++) {
        const player = formData.get(`action_player_${i}`);
        const type = formData.get(`action_type_${i}`);
        const amount = formData.get(`action_amount_${i}`);
        
        if (player && type) {
            actions.push({
                player_name: player,
                action_type: type,
                amount: amount ? parseFloat(amount) : 0
            });
        }
    }
    
    // リクエストデータを構築
    const requestData = {
        players: players,
        actions: actions,
        small_blind: parseFloat(formData.get('small_blind')),
        big_blind: parseFloat(formData.get('big_blind')),
        hole_cards: holeCards
    };
    
    // ボードカードを追加
    const flop = formData.get('flop');
    const turn = formData.get('turn');
    const river = formData.get('river');
    
    if (flop) requestData.flop = flop;
    if (turn) requestData.turn = turn;
    if (river) requestData.river = river;
    
    // APIリクエストを送信
    fetch('/api/save-hand', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        const resultDiv = document.getElementById('form-result');
        if (data.status === 'success') {
            resultDiv.innerHTML = `
                <div class="card bg-green-50 border border-green-200">
                    <div class="text-green-800">
                        <h4 class="font-bold">Hand saved successfully!</h4>
                        <p>Play ID: ${data.play_id}</p>
                        <p>Hand ID: ${data.hand_id}</p>
                        <div class="mt-4">
                            <h5 class="font-bold">Generated PHH:</h5>
                            <pre class="bg-gray-100 p-4 rounded mt-2 text-sm overflow-x-auto">${data.phh_content}</pre>
                        </div>
                    </div>
                </div>
            `;
        } else {
            resultDiv.innerHTML = `
                <div class="card bg-red-50 border border-red-200">
                    <div class="text-red-800">
                        <h4 class="font-bold">An error occurred</h4>
                        <p>${data.error}</p>
                    </div>
                </div>
            `;
        }
    })
    .catch(error => {
        document.getElementById('form-result').innerHTML = `
            <div class="card bg-red-50 border border-red-200">
                <div class="text-red-800">
                    <h4 class="font-bold">Communication error occurred</h4>
                    <p>${error.message}</p>
                </div>
            </div>
        `;
    });
});
</script>
{% endblock %}